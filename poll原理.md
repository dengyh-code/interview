`poll`是一种在 Unix/Linux 系统中用于进行 I/O 多路复用的系统调用。它的主要原理是监视一组文件描述符，以确定哪些文件描述符上有可进行的 I/O 操作。

**一、基本概念**

1. 文件描述符：在 Unix/Linux 系统中，文件描述符是一个整数，用于标识打开的文件、套接字、管道等。每个进程都有一个文件描述符表，用于跟踪它打开的文件和资源。
2. 事件结构体：`poll`使用一个事件结构体数组来指定要监视的文件描述符和感兴趣的事件类型。事件结构体通常包含文件描述符、事件掩码和一个用于存储返回事件的字段。
3. 事件掩码：事件掩码是一个位掩码，用于指定对文件描述符感兴趣的事件类型。常见的事件类型包括可读（POLLIN）、可写（POLLOUT）和异常（POLLERR、POLLHUP 等）。

**二、工作流程**

1. 初始化事件结构体数组：
   - 首先，应用程序创建一个事件结构体数组，并将需要监视的文件描述符和感兴趣的事件类型填充到数组中。
   - 例如，以下代码展示了如何初始化一个事件结构体数组来监视两个文件描述符的可读事件：
     ```c
     struct pollfd fds[2];
     fds[0].fd = file_descriptor_1;
     fds[0].events = POLLIN;
     fds[1].fd = file_descriptor_2;
     fds[1].events = POLLIN;
     ```

2. 调用`poll`系统调用：
   - 应用程序调用`poll`系统调用，并将事件结构体数组和超时时间作为参数传递给它。
   - `poll`系统调用会阻塞应用程序，直到有一个或多个文件描述符上的事件发生，或者超时时间到达。
   - 例如，以下代码展示了如何调用`poll`系统调用：
     ```c
     int ret = poll(fds, 2, -1);
     ```
   - 在这个例子中，`poll`将阻塞直到有事件发生，因为超时时间被设置为 -1，表示无限等待。

3. 处理返回结果：
   - 当`poll`系统调用返回时，应用程序可以检查返回值和事件结构体数组，以确定哪些文件描述符上有事件发生。
   - 返回值表示有事件发生的文件描述符的数量。如果返回值为 0，表示超时时间到达，没有文件描述符上有事件发生。如果返回值为 -1，表示发生了错误。
   - 应用程序可以遍历事件结构体数组，检查每个文件描述符的`revents`字段，以确定实际发生的事件类型。
   - 例如，以下代码展示了如何处理`poll`的返回结果：
     ```c
     if (ret > 0) {
         for (int i = 0; i < 2; i++) {
             if (fds[i].revents & POLLIN) {
                 // 文件描述符 i 上有可读事件发生
                 // 进行相应的处理
             }
         }
     } else if (ret == 0) {
         // 超时时间到达，没有事件发生
     } else {
         // 发生了错误
     }
     ```

**三、优点和应用场景**

1. 优点：
   - `poll`相对于其他 I/O 多路复用技术（如`select`）具有一些优点。它可以监视的文件描述符数量没有限制（实际上受限于系统内存），并且在处理大量文件描述符时性能更好。
   - `poll`还支持水平触发和边缘触发两种模式，可以根据应用程序的需求进行选择。

2. 应用场景：
   - `poll`通常用于网络服务器、事件驱动的应用程序和需要同时监视多个文件描述符的场景。例如，一个网络服务器可以使用`poll`来监视多个客户端连接的套接字，以确定哪些套接字上有数据可读或可写。
   - 它也可以用于实现异步 I/O 框架，通过监视文件描述符上的事件来触发相应的回调函数。

总之，`poll`是一种强大的 I/O 多路复用技术，它允许应用程序同时监视多个文件描述符，以确定哪些文件描述符上有可进行的 I/O 操作。通过合理地使用`poll`，可以提高应用程序的性能和响应能力，特别是在处理大量并发连接或需要同时监视多个资源的场景下。
